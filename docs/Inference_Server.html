---

title: Lesson 5 - Server Implementation


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/course2020/vision/05_Inference_Server.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/course2020/vision/05_Inference_Server.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/mnt/d/lib/python3.7/site-packages/torch/cuda/__init__.py:52: UserWarning: CUDA initialization: Found no NVIDIA driver on your system. Please check that you have an NVIDIA GPU and installed a driver from http://www.nvidia.com/Download/index.aspx (Triggered internally at  /pytorch/c10/cuda/CUDAFunctions.cpp:100.)
  return torch._C._cuda_getDeviceCount() &gt; 0
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Lesson-Video:">Lesson Video:<a class="anchor-link" href="#Lesson-Video:"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

        <iframe
            width="400"
            height="300"
            src="https://www.youtube.com/embed/4w3sEgqDvSo?start=1920"
            frameborder="0"
            allowfullscreen
        ></iframe>
        
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea output_execute_result">
<hr>
<p>This article is also a Jupyter Notebook available to be run from the top down. There
will be code snippets that you can then run in any environment.</p>
<p>Below are the versions of <code>fastai</code>, <code>fastcore</code>, <code>wwf</code>, and <code>nbdev</code> currently running at the time of writing this:</p>
<ul>
<li><code>fastai</code>: 2.1.10 </li>
<li><code>fastcore</code>: 1.3.13 </li>
<li><code>wwf</code>: 0.0.7 </li>
<li><code>nbdev</code>: 1.1.5 </li>
</ul>
<hr>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's now take what we had before and run inference based on a list of filenames. We'll make a quick script to get the ball rolling for how we want everything to do using <code>nbdev</code> again</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll want the libraries we've used</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.vision.all</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Including our new <code>style_transfer.py</code> file</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">wwf.style_transfer</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's grab our original style image</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">load_learner</span><span class="p">(</span><span class="s1">&#39;myModel&#39;</span><span class="p">,</span> <span class="n">cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And now we can make and prepare our dataloader with a filename!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dset</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="s1">&#39;cat.jpg&#39;</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[</span><span class="n">PILImage</span><span class="o">.</span><span class="n">create</span><span class="p">])</span>
<span class="n">dl</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">after_item</span><span class="o">=</span><span class="p">[</span><span class="n">ToTensor</span><span class="p">()],</span> <span class="n">after_batch</span><span class="o">=</span><span class="p">[</span><span class="n">IntToFloatTensor</span><span class="p">(),</span> <span class="n">Normalize</span><span class="o">.</span><span class="n">from_stats</span><span class="p">(</span><span class="o">*</span><span class="n">imagenet_stats</span><span class="p">)],</span> <span class="n">bs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t_im</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And get our raw output.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">t_im</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's wrap this into a function</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_learner" class="doc_header"><code>get_learner</code><a href="https://github.com/walkwithfastai/walkwithfastai.github.io/tree/master/wwf/deployment.py#L12" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_learner</code>(<strong><code>fn</code></strong>, <strong><code>cpu</code></strong>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_learner</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">load_learner</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">cpu</span><span class="o">=</span><span class="n">cpu</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_datasets" class="doc_header"><code>make_datasets</code><a href="https://github.com/walkwithfastai/walkwithfastai.github.io/tree/master/wwf/deployment.py#L16" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_datasets</code>(<strong><code>learn</code></strong>, <strong><code>fns</code></strong>, <strong><code>bs</code></strong>=<em><code>1</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">make_datasets</span><span class="p">(</span><span class="n">learn</span><span class="p">,</span> <span class="n">fns</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
  <span class="n">cuda</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">is_cuda</span>
  <span class="n">dset</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">fns</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[</span><span class="n">PILImage</span><span class="o">.</span><span class="n">create</span><span class="p">])</span>
  <span class="k">if</span> <span class="n">cuda</span><span class="p">:</span> 
    <span class="n">after_batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">IntToFloatTensor</span><span class="p">(),</span> <span class="n">Normalize</span><span class="o">.</span><span class="n">from_stats</span><span class="p">(</span><span class="o">*</span><span class="n">imagenet_stats</span><span class="p">)]</span> 
    <span class="n">dl</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">after_item</span><span class="o">=</span><span class="p">[</span><span class="n">ToTensor</span><span class="p">()],</span> <span class="n">after_batch</span><span class="o">=</span><span class="n">after_batch</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span> 
    <span class="n">after_batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">Normalize</span><span class="o">.</span><span class="n">from_stats</span><span class="p">(</span><span class="o">*</span><span class="n">imagenet_stats</span><span class="p">,</span> <span class="n">cuda</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
    <span class="n">dl</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">after_item</span><span class="o">=</span><span class="p">[</span><span class="n">ToTensor</span><span class="p">()],</span> <span class="n">after_batch</span><span class="o">=</span><span class="n">after_batch</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">dl</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torchvision.utils</span> <span class="kn">import</span> <span class="n">save_image</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can write a quick <a href="/Inference_Server.html#save_im"><code>save_im</code></a> function to save all our outputed tensors to images</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="save_im" class="doc_header"><code>save_im</code><a href="https://github.com/walkwithfastai/walkwithfastai.github.io/tree/master/wwf/deployment.py#L31" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>save_im</code>(<strong><code>imgs</code></strong>:<code>list</code>, <strong><code>path</code></strong>)</p>
</blockquote>
<p>Save a n<em>c</em>w*h <code>Tensor</code> into seperate images</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">save_im</span><span class="p">(</span><span class="n">imgs</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
  <span class="s2">&quot;Save a n*c*w*h `Tensor` into seperate images&quot;</span>
  <span class="p">[</span><span class="n">save_image</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imgs</span><span class="p">)]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's put it all together</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="inference" class="doc_header"><code>inference</code><a href="https://github.com/walkwithfastai/walkwithfastai.github.io/tree/master/wwf/deployment.py#L36" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>inference</code>(<strong><code>pkl_name</code></strong>, <strong><code>fnames</code></strong>:<code>list</code>, <strong><code>path</code></strong>:<code>Path</code>, <strong><code>cpu</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>
<p>Grab inference on a model, filenames, and a path to save it to</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">inference</span><span class="p">(</span><span class="n">pkl_name</span><span class="p">,</span> <span class="n">fnames</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span><span class="n">Path</span><span class="p">,</span> <span class="n">cpu</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="s2">&quot;Grab inference on a model, filenames, and a path to save it to&quot;</span>
  <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">/</span><span class="s1">&#39;results&#39;</span>
  <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">learn</span> <span class="o">=</span> <span class="n">get_learner</span><span class="p">(</span><span class="n">pkl_name</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">dls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
      <span class="n">dls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_datasets</span><span class="p">(</span><span class="n">learn</span><span class="p">,</span> <span class="n">fnames</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">dls</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_datasets</span><span class="p">(</span><span class="n">learn</span><span class="p">,</span> <span class="n">fnames</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
  <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">dls</span><span class="p">:</span>
    <span class="n">t_im</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">t_im</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
  <span class="n">save_im</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And try it out!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cat.jpg&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">inference</span><span class="p">(</span><span class="s1">&#39;myModel&#39;</span><span class="p">,</span> <span class="n">fnames</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Lastly let's make a <code>.py</code> file again to run it off of</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And we're done!</p>

</div>
</div>
</div>
</div>
 

